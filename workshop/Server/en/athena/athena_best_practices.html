<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<html lang="en" class="js csstransforms3d">
<head>
  <meta charset="utf-8">
  <meta property="og:title" content="Bring Your Own Data Labs (BYOD)" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="generator" content="Hugo 0.63.1" />
  <meta name="description" content="Bring Your Own Data Labs (BYOD)">
<meta name="author" content="Ahmed Hany Architect">

  <link rel="shortcut icon" href="https://a0.awsstatic.com/libra-css/images/site/fav/favicon.ico" type="image/ico" />
<link rel="icon" href="https://a0.awsstatic.com/libra-css/images/site/fav/favicon.ico" type="image/ico" />

  <title>Optional - Amazon Athena Best Practices :: Bring Your Own Data Labs (BYOD)</title>

  
  <link href="../../css/nucleus.css" rel="stylesheet">
  <link href="../../css/fontawesome-all.min.css" rel="stylesheet">
  <link href="../../css/hybrid.css" rel="stylesheet">
  <link href="../../css/featherlight.min.css" rel="stylesheet">
  <link href="../../css/perfect-scrollbar.min.css" rel="stylesheet">
  <link href="../../css/auto-complete.css" rel="stylesheet">
  <link href="../../css/atom-one-dark-reasonable.css" rel="stylesheet">
  <link href="../../css/theme.css" rel="stylesheet">
  <link href="../../css/hugo-theme.css" rel="stylesheet">
  
  <link href="../../css/theme-aws.css" rel="stylesheet">
  

  <script src="../../js/jquery-3.6.0.min.js"></script>

  <style>
    :root #header + #content > #left > #rlblock_left{
        display:none !important;
    }
    
      :not(pre) > code + span.copy-to-clipboard {
          display: none;
      }
    
  </style>
  
</head>

<body class="" data-url="/en/athena/athena_best_practices.html">
  <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <div>
    <a href="../../" title="Go home">
        <img style="vertical-align:middle" src="../../images/logo.png" height="70px" />
    </a>
</div>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="../../js/lunr.min.js"></script>
<script type="text/javascript" src="../../js/auto-complete.js"></script>
<script type="text/javascript">
    
        var baseurl = "\/en";
    
</script>
<script type="text/javascript" src="../../js/search.js"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/en/requirements.html" title="Requirements" class="dd-item 
        
        
        
        ">
      <a href="../../en/requirements.html">
          <b>1. </b>Requirements
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/en/requirements/knowledge.html" title="Required Knowledge" class="dd-item 
        
        
        
        ">
      <a href="../../en/requirements/knowledge.html">
          Required Knowledge
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/en/requirements/prerequisites.html" title="Required Prerequisites" class="dd-item 
        
        
        
        ">
      <a href="../../en/requirements/prerequisites.html">
          Required Prerequisites
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/en/glue.html" title="Ingestion with Glue" class="dd-item 
        
        
        
        ">
      <a href="../../en/glue.html">
          <b>2. </b>Ingestion with Glue
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/en/glue/21_permissions.html" title="Configure Permissions" class="dd-item ">
        <a href="../../en/glue/21_permissions.html">
        <b>2.1. </b>Configure Permissions
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/glue/22_raw_crawler.html" title="Create data catalog from S3 files" class="dd-item ">
        <a href="../../en/glue/22_raw_crawler.html">
        <b>2.2. </b>Create data catalog from S3 files
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/glue/23_transform_with_glue_job.html" title="Transform the data to Parquet format" class="dd-item ">
        <a href="../../en/glue/23_transform_with_glue_job.html">
        <b>2.3. </b>Transform the data to Parquet format
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/glue/24_curated_crawler.html" title="Add a crawler for curated data" class="dd-item ">
        <a href="../../en/glue/24_curated_crawler.html">
        <b>2.4. </b>Add a crawler for curated data
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/glue/25_schema_validation.html" title="Schema Validation" class="dd-item ">
        <a href="../../en/glue/25_schema_validation.html">
        <b>2.5. </b>Schema Validation
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/glue/26_testing_pyspark_locally.html" title="Testing Pyspark Locally with Docker" class="dd-item ">
        <a href="../../en/glue/26_testing_pyspark_locally.html">
        <b>2.6. </b>Testing Pyspark Locally with Docker
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/glue/27_optional_dev_endpoint.html" title="Optional: Creating a Development Endpoint for Glue" class="dd-item ">
        <a href="../../en/glue/27_optional_dev_endpoint.html">
        <b>2.7 </b>Optional: Creating a Development Endpoint for Glue
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/en/orchestration.html" title="Orchestrating the data pipeline" class="dd-item 
        
        
        
        ">
      <a href="../../en/orchestration.html">
          <b>3. </b>Orchestrating the data pipeline
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/en/athena.html" title="Interactive SQL Queries Using Amazon Athena" class="dd-item 
        parent
        
        
        ">
      <a href="../../en/athena.html">
          <b>4. </b>Interactive SQL Queries Using Amazon Athena
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/en/athena/athena_best_practices.html" title="Optional - Amazon Athena Best Practices" class="dd-item active">
        <a href="../../en/athena/athena_best_practices.html">
        Optional - Amazon Athena Best Practices
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/athena/optional.html" title="Interactive SQL - Optional Labs" class="dd-item ">
        <a href="../../en/athena/optional.html">
        Interactive SQL - Optional Labs
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/en/visualization.html" title="Visualization using Amazon QuickSight" class="dd-item 
        
        
        
        ">
      <a href="../../en/visualization.html">
          <b>5. </b>Visualization using Amazon QuickSight
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/en/transformations.html" title="Transformations" class="dd-item 
        
        
        
        ">
      <a href="../../en/transformations.html">
          <b>6. </b>Transformations
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/en/wrapup.html" title="Wrap up and cleaning existing resources" class="dd-item 
        
        
        
        ">
      <a href="../../en/wrapup.html">
          <b>7. </b>Wrap up and cleaning existing resources
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
        <li>
          <a class="padding">
            <i class="fas fa-language fa-fw"></i>
          <div class="select-style">
            <select id="select-language" onchange="location = this.value;">
          
          
          
              
              
                  
                    
                    
                      <option id="en" value="/en/athena/athena_best_practices.html" selected>English</option>
                    
                  
              
                  
              
          
        </select>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="255px" height="255px" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255;" xml:space="preserve">
          <g>
            <g id="arrow-drop-down">
              <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
            </g>
          </g>
        </svg>
        </div>
        </a>
        </li>
      
      
      
      </ul>
    </section>
    
    <section id="footer">
      <left>

    <a href="https://aws.amazon.com/privacy/?nc1=f_pr">Privacy</a> | <a href="https://aws.amazon.com/terms/?nc1=f_pr">Site Terms</a> | Â© 2020, Amazon Web Services, Inc. or its affiliates. All rights reserved. 

</left>

    </section>
  </div>
</nav>





  <section id="body">
    <div id="overlay"></div>
    <div class="padding highlightable">
      
      <div>
        <div id="top-bar">
          
          
          <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
            <span id="sidebar-toggle-span">
              <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                <i class="fa fa-bars"></i>
              </a>
            </span>
            
            <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
            
            <span class="links">
              
          
          
          
          
          
          
          
          
          
          
          <a href='../../en/'>Bring Your Own Data Labs (BYOD)</a> > <a href='../../en/athena.html'>Interactive SQL Queries Using Amazon Athena</a> > Optional - Amazon Athena Best Practices
          
          
          
          
          
          
            </span>
          </div>
          
          <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#using-columnar-storage">Using Columnar Storage</a></li>
    <li><a href="#partitioning-your-data">Partitioning your Data</a></li>
    <li><a href="#bucketing-your-data">Bucketing your Data</a>
      <ul>
        <li><a href="#what-is-create-table-as-select">What is &lsquo;CREATE TABLE AS SELECT&rsquo;</a></li>
        <li><a href="#using-ctas-to-create-partitioned-subset">Using CTAS to create Partitioned Subset</a></li>
        <li><a href="#using-ctas-to-create-partitioned-and-bucketed-subset">Using CTAS to create Partitioned and Bucketed Subset</a></li>
        <li><a href="#comparing-results">Comparing Results</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

          
        </div>
      </div>
      

      
        <div id="body-inner">
          <h1>Optional - Amazon Athena Best Practices</h1>
          
          


<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#using-columnar-storage">Using Columnar Storage</a></li>
<li><a href="#partitioning-your-data">Partitioning your Data</a></li>
<li><a href="#bucketing-your-data">Bucketing your Data</a>
<ul>
<li><a href="#what-is-create-table-as-select">What is &lsquo;CREATE TABLE AS SELECT&rsquo;</a></li>
<li><a href="#using-ctas-to-create-partitioned-subset">Using CTAS to create Partitioned Subset</a></li>
<li><a href="#using-ctas-to-create-partitioned-and-bucketed-subset">Using CTAS to create Partitioned and Bucketed Subset</a></li>
<li><a href="#comparing-results">Comparing Results</a></li>
</ul>
</li>
</ul>
<h2 id="introduction">Introduction</h2>
<p>In the first Lab (<a href="../01_ingestion_with_glue/README.md">Lab 1: Ingestion with Glue</a>) we did one transformation to the data; <em>changed the format to parquet</em>. <em>Partitioning</em> and <em>bucketing</em> are other common best practices. Partitioning, is a way to organizes tables into partitions by dividing tables into different parts based on partition keys. While Bucketing, buckets your data into groups within a single partition.</p>
<p>This lab discusses <a href="https://aws.amazon.com/blogs/big-data/top-10-performance-tuning-tips-for-amazon-athena/" target="_blank">common best practices</a>) that enable you to get the most out of Athena.</p>
<p>Before doing this let&rsquo;s discuss how Athena <a href="https://aws.amazon.com/athena/pricing/" target="_blank">pricing</a> works. With Athena, you are charged for the number of bytes scanned by Amazon Athena, rounded up to the nearest megabyte, with a 10MB minimum per query. Thus, the aim is to run the query with least amount of data scanned.</p>
<p>We will run the same query before and after we do the optimisation to see how these recommendations significantly reduce the amount of data scanned, and thus, reducing cost and improving performance.</p>
<h2 id="using-columnar-storage">Using Columnar Storage</h2>
<p>Apache Parquet is a popular columnar storage format that is optimised for fast retrieval of data and used in AWS analytical applications. Parquet and other popular columnar storage formats have <em>three</em> main benefits that make them suitable for using with Athena;</p>
<ul>
<li><em>Compression by column</em>, and thus, better compression rate and lower storage cost.</li>
<li><em>Predicate pushdown</em> enables Athena queries to fetch only the blocks it needs, improving query performance. When an Athena query obtains specific column values from your data, it uses statistics from data block predicates, such as max/min values, to determine whether to read or skip the block.</li>
<li><em>Splitting of data</em> allows Athena to split the reading of data to multiple readers and increase parallelism during its query processing.</li>
</ul>
<p>Now let&rsquo;s compare the amount of data scanned when we run the same query on the raw and curated tables</p>
<ol>
<li>Open the <a href="https://console.aws.amazon.com/athena/home" target="_blank">AWS Management Console for Athena</a> and make sure you are on the same AWS Region.</li>
<li>Choose the <em>{raw database}</em> from the dropdown menu and execute the following query:</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">
<span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> <span style="color:#960050;background-color:#1e0010">{</span>raw_table_name<span style="color:#960050;background-color:#1e0010">}</span>

</code></pre></div><ol start="3">
<li>
<p>Wait the query to execute and note the amount of <strong>Data scanned</strong> by the query.
<img src="../../athena_img/athena_query_noparq.png" alt="image"></p>
</li>
<li>
<p>Let&rsquo;s run the same query on the optimised data to compare the difference. Choose the <em>{curated database}</em> from the dropdown menu and execute the same query with the new {curated_table_name}.</p>
</li>
<li>
<p>Wait for the query to execute the note the amount of <strong>Data Scanned</strong>
<img src="../../athena_img/athena_query_parq.png" alt="image"></p>
</li>
</ol>
<p>You noticed in this lab by converting to Columnar storage format, you significantly reduced the amount of data scanned, and thus, reducing Athena costs and improving performance.</p>
<h2 id="partitioning-your-data">Partitioning your Data</h2>
<p>By partitioning your data, you can restrict the amount of data scanned by each query, thus improving performance and reducing cost. Athena leverages Hive for partitioning data. You can partition your data by any key. A common practice is to partition the data based on time, often leading to a multi-level partitioning scheme.</p>
<p>To see the benefit of partitioning, let&rsquo;s run the same query on the raw (non partitioned) and curated (partitioned). This time the query should filter the results using the <em>WHERE</em> clause in the SQL statement. The aim is use the column used to partition the data to filter the results.</p>
<ol>
<li>Open the <a href="https://console.aws.amazon.com/athena/home" target="_blank">AWS Management Console for Athena</a> and make sure you are on the same AWS Region.</li>
<li>Choose the <em>{raw database}</em> from the dropdown menu and execute the following query:</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">
<span style="color:#66d9ef">SELECT</span> <span style="color:#66d9ef">count</span>(<span style="color:#f92672">*</span>) <span style="color:#66d9ef">AS</span> FilterCount 
<span style="color:#66d9ef">from</span> <span style="color:#960050;background-color:#1e0010">{</span>raw_table_name<span style="color:#960050;background-color:#1e0010">}</span> 
<span style="color:#66d9ef">where</span> <span style="color:#960050;background-color:#1e0010">{</span>condition_on_partitioned_column<span style="color:#960050;background-color:#1e0010">}</span>

</code></pre></div><ol start="3">
<li>
<p>Wait the query to execute and note the amount of <strong>Data scanned</strong> by the query.
<img src="../../athena_img/athena_query_nopart.png" alt="image"></p>
</li>
<li>
<p>Let&rsquo;s run the same query on the optimised data to compare the difference. Choose the <em>{curated database}</em> from the dropdown menu and execute the same query with the new {table_name_curated}.</p>
</li>
<li>
<p>Wait for the query to execute the note the amount of <strong>Data Scanned</strong>
<img src="../../athena_img/athena_query_part.png" alt="image"></p>
</li>
</ol>
<p>You learnt in this lab that if you have many queries that are filtered in the WHERE clause, then the column used to filter the query result would be a good partitioning candidate. By partitioning your data you will  significantly reduce the amount of data scanned, and thus, reducing Athena costs and improving performance.</p>
<h2 id="bucketing-your-data">Bucketing your Data</h2>
<p>An additional optimisation supported by Athena is <em>bucketing</em>. Partitioning is used to group similar types of data based on a specific column. Bucketing is commonly used to combine data within a partition into a number of equal groups, or files. Therefore, partitioning is best suited for low cardinality columns and bucketing is best suited for high cardinality columns.</p>
<p>Bucketing your data, is another common technique that improves Athena performance and cost. For more information, see <a href="https://docs.aws.amazon.com/athena/latest/ug/bucketing-vs-partitioning.html" target="_blank">Bucketing vs Partitioning</a>.</p>
<p>You can use <code>CREATE TABLE AS SELECY</code>(CTAS) query to bucket the data within a partition. This lab, we will cover, how to use CTAS to physically create a subset table. <em>Two</em> identical subset tables will be created; the first one is <em>partitioned</em> and the second one is <em>bucketed</em> and <em>partitioned</em>. Finally, we will run the same query on both subset tables and compare the results.</p>
<blockquote>
<p>Note: This lab will run on the Curated Table</p>
</blockquote>
<h3 id="what-is-create-table-as-select">What is &lsquo;CREATE TABLE AS SELECT&rsquo;</h3>
<p><strong>[OPTIONAL]</strong></p>
<p>A <code>CREATE TABLE AS SELECT</code> (CTAS) query creates a new table in Athena from the results of a <code>SELECT</code> statement from another query. Athena stores data files created by the CTAS statement in a specified location in Amazon S3</p>
<blockquote>
<p>Note: You not need to create the S3 folder before running the CTAS query; Athena will do it for you. Just choose the S3 path to store the data. Feel free to use any path as long as you own the  S3 bucket and it is in the same region you are using throughout this lab.
If you choose to create the folder before running the query, make sure the folder is empty otherwise the query will fail.</p>
</blockquote>
<p>Use CTAS queries to:</p>
<ul>
<li>Create tables from query results in one step, without repeatedly querying raw data sets. This is useful if you want to create a new table from the results of joining two tables.</li>
<li>Transform query results into other storage formats, such as Parquet and ORC. This improves query performance and reduces query costs in Athena.</li>
<li>Create copies of existing tables that contain only the data (subset of the table) you need.</li>
<li>Bucketing and/or partitioning your data.</li>
</ul>
<h3 id="using-ctas-to-create-partitioned-subset">Using CTAS to create Partitioned Subset</h3>
<ol>
<li>Open the <a href="https://console.aws.amazon.com/athena/home" target="_blank">AWS Management Console for Athena</a> and make sure you are on the same AWS Region.</li>
<li>Choose the <em>{curated database}</em> from the dropdown menu and execute the following query:</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">
<span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> subset 
<span style="color:#66d9ef">WITH</span> (
     format <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">PARQUET</span><span style="color:#e6db74">&#39;</span>, 
     external_location <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">s3://{athena-s3-bucket}/{first_subset}/</span><span style="color:#e6db74">&#39;</span>, 
     partitioned_by <span style="color:#f92672">=</span> ARRAY[<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{col1}</span><span style="color:#e6db74">&#39;</span>,<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{col2}</span><span style="color:#e6db74">&#39;</span>, etc ...], 
) 
<span style="color:#66d9ef">AS</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> 
<span style="color:#66d9ef">FROM</span> <span style="color:#960050;background-color:#1e0010">{</span>curated_table_name<span style="color:#960050;background-color:#1e0010">}</span>
<span style="color:#66d9ef">where</span> <span style="color:#960050;background-color:#1e0010">{</span>CTAS_condition<span style="color:#960050;background-color:#1e0010">}</span>

</code></pre></div><p><img src="../../athena_img/athena_ctas_buck.png" alt="image"></p>
<ol start="3">
<li>Navigate to S3 and check the newly created files
<img src="../../athena_img/athena_ctas_s3_nobuck.png" alt="image"></li>
</ol>
<h3 id="using-ctas-to-create-partitioned-and-bucketed-subset">Using CTAS to create Partitioned and Bucketed Subset</h3>
<ol>
<li>Choose the <em>{curated database}</em> from the dropdown menu and execute the following query:</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> subset_bucketed 
<span style="color:#66d9ef">WITH</span> (
     format <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">PARQUET</span><span style="color:#e6db74">&#39;</span>, 
     external_location <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">s3://{athena-s3-bucket}/{first_subset}/</span><span style="color:#e6db74">&#39;</span>, 
     partitioned_by <span style="color:#f92672">=</span> ARRAY[<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{col1}</span><span style="color:#e6db74">&#39;</span>,<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{col2}</span><span style="color:#e6db74">&#39;</span>,etc..], 
     bucketed_by <span style="color:#f92672">=</span> ARRAY[<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{primary_key}</span><span style="color:#e6db74">&#39;</span>], 
     bucket_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>) 
<span style="color:#66d9ef">AS</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> 
<span style="color:#66d9ef">FROM</span> <span style="color:#960050;background-color:#1e0010">{</span>curated_table_name<span style="color:#960050;background-color:#1e0010">}</span>
<span style="color:#66d9ef">WHERE</span> <span style="color:#960050;background-color:#1e0010">{</span>CTAS_condition<span style="color:#960050;background-color:#1e0010">}</span>

</code></pre></div><p><img src="../../athena_img/athena_ctas_buck.png" alt="image"></p>
<ol start="2">
<li>Navigate to S3 and check the newly created files. Notice that data within one partition is bucketed into <em>5 (configured in the CTAS query)</em> different files
<img src="../../athena_img/athena_ctas_s3_buck.png" alt="image"></li>
</ol>
<h3 id="comparing-results">Comparing Results</h3>
<blockquote>
<p>Note: <strong>{primary_key}</strong> here should be the column used for <em><strong>bucketing</strong></em>. Columns with high cardinality (high number or unique values) that are spread evenly are good candidates for <em>bucketing</em>.</p>
</blockquote>
<ol>
<li>In Athena Console, execute the following query on the new table (subset)</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">AS</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> 
<span style="color:#66d9ef">FROM</span> subset
<span style="color:#66d9ef">WHERE</span> <span style="color:#960050;background-color:#1e0010">{</span>primary_key<span style="color:#960050;background-color:#1e0010">}</span> <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">{</span>value<span style="color:#960050;background-color:#1e0010">}</span> 

</code></pre></div><ol start="2">
<li>
<p>Wait for the query to finish and note the amount of <strong>data scanned</strong> by the query.
<img src="../../athena_img/athena_subset_nobuck.png" alt="image"></p>
</li>
<li>
<p>In the <strong>Query Editor</strong>, execute the following query on the new table (subset_bucketed)</p>
</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">AS</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> 
<span style="color:#66d9ef">FROM</span> subset_bucketed
<span style="color:#66d9ef">WHERE</span> <span style="color:#960050;background-color:#1e0010">{</span>primary_key<span style="color:#960050;background-color:#1e0010">}</span> <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">{</span>value<span style="color:#960050;background-color:#1e0010">}</span> 

</code></pre></div><ol start="4">
<li>Wait for the query to finish and note the amount of <strong>data scanned</strong> by the query.
<img src="../../athena_img/athena_subset_buck.png" alt="image"></li>
</ol>
<p>In this lab we learnt that bucketing is also a very useful optimisation. Columns with high cardinality (high number of unique values) that are evenly spread are good candidates for bucketing. Bucketing distribute the data to different files within a partition. So if we want to filter a partition, Athena will only scan the relevant bucket files not the whole partition.</p>


<footer class=" footline" >
	
</footer>


        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="../../en/athena.html" title="Interactive SQL Queries Using Amazon Athena"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="../../en/athena/optional.html" title="Interactive SQL - Optional Labs" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="../../js/clipboard.min.js"></script>
    <script src="../../js/perfect-scrollbar.min.js"></script>
    <script src="../../js/perfect-scrollbar.jquery.min.js"></script>
    <script src="../../js/jquery.sticky.js"></script>
    <script src="../../js/featherlight.min.js"></script>
    <script src="../../js/html5shiv-printshiv.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="../../js/modernizr.custom-3.6.0.js"></script>
    <script src="../../js/learn.js"></script>
    <script src="../../js/hugo-learn.js"></script>

    <link href="../../mermaid/mermaid.css" rel="stylesheet" />
    <script src="../../mermaid/mermaid.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    <div id = 'kinesisStreamName' title = ""/></div>
<div id = 'cognitoPoolId' title = ""/></div>
<div id = 'awsRegion' title = ""/></div>
<div id = 'contentId' title = ""/></div>
<div id = 'language' title = "en"/></div>
<div id = 'versions' title = ""/></div>

<script src="https://sdk.amazonaws.com/js/aws-sdk-2.283.1.min.js"></script>
<script src="../../js/kinesis.js"></script>
  </body>
</html>

